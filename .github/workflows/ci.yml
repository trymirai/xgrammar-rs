name: CI

on:
    push:
        branches: [main, add-sources]
    pull_request:
        branches: [main]
    release:
        types: [published]

env:
    CARGO_TERM_COLOR: always

jobs:
    test:
        name: Test on macOS
        runs-on: macos-latest

        steps:
            - uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Install CMake
              run: brew install cmake

            - name: Cache cargo registry
              uses: actions/cache@v4
              with:
                  path: ~/.cargo/registry
                  key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

            - name: Cache cargo index
              uses: actions/cache@v4
              with:
                  path: ~/.cargo/git
                  key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

            - name: Cache target directory
              uses: actions/cache@v4
              with:
                  path: target
                  key: ${{ runner.os }}-target-${{ hashFiles('**/Cargo.lock') }}

            - name: Run tests (without HF feature)
              run: cargo test --verbose

            - name: Run tests (with HF feature)
              env:
                  HF_TOKEN: ${{ secrets.HF_TOKEN }}
              run: cargo test --features hf --verbose

            - name: Build documentation
              run: cargo doc --no-deps --features hf

    publish:
        name: Publish to crates.io
        runs-on: macos-latest
        needs: test
        if: github.event_name == 'release'

        steps:
            - uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Install Rust
              uses: dtolnay/rust-toolchain@stable

            - name: Install CMake
              run: brew install cmake

            - name: Publish to crates.io
              env:
                  CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
              run: cargo publish --allow-dirty
