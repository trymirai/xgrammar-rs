name: Release

on:
  release:
    types: [published]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test before publish
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Install CMake
      run: brew install cmake
    
    - name: Run tests (without HF feature)
      run: cargo test --verbose
    
    - name: Run tests (with HF feature)
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: cargo test --features hf --verbose

  publish:
    name: Publish to crates.io
    runs-on: macos-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Install CMake
      run: brew install cmake
    
    - name: Verify package
      run: cargo publish --dry-run --allow-dirty
    
    - name: Publish to crates.io
      env:
        CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
      run: cargo publish --allow-dirty

